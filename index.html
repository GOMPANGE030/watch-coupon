<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>모든G, 다되G! | 모든G 영상 시청하고 쿠폰도 받아보세요!</title>
  <style>
    :root{
      --bg:#f9f9f9; --text:#111827; --muted:#6B7280; --card:#ffffff; --stroke:#e5e7eb;
      --cta-bg:#00ffb6; --cta-text:#ffffff; --cta-bg-disabled:#cffff0; --cta-text-disabled:#6ea091;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}

    .shell{min-height:100dvh;display:flex;flex-direction:column}
    .wrap{width:100%;max-width:720px;margin:0 auto;padding:0 calc(16px + env(safe-area-inset-right)) 0 calc(16px + env(safe-area-inset-left))}
    header{position:sticky;top:0;z-index:10;background:rgba(249,249,249,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--stroke)}
    .header{height:72px;display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:0 calc(14px + env(safe-area-inset-right)) 0 calc(14px + env(safe-area-inset-left))}
    .logo{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo-badge{width:32px;height:32px;border-radius:8px;overflow:hidden}
    .logo-badge img{width:100%;height:100%;object-fit:cover;display:block}

    .btn{appearance:none;border:0;border-radius:14px;
      padding:clamp(10px,2.8vw,14px) clamp(12px,3.8vw,18px);
      font-weight:800;cursor:pointer;font-size:clamp(14px,3.8vw,16px);
      transition:transform .15s, box-shadow .2s, background .2s, opacity .2s; max-width:100%; white-space:nowrap}
    .btn-primary{background:var(--cta-bg);color:var(--cta-text);box-shadow:0 4px 14px rgba(0,0,0,.12)}
    .btn-primary[disabled]{background:var(--cta-bg-disabled);color:var(--cta-text-disabled);opacity:1;cursor:not-allowed}
    .btn-primary.active{box-shadow:0 0 0 3px rgba(17,24,39,.08),0 10px 28px rgba(0,0,0,.2);animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}

    main{flex:1}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);margin:16px 0;padding:18px}
    h1{font-size:20px;margin:0 0 8px}
    .muted{color:var(--muted);font-size:14px}

    /* 플레이어 */
    .player-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;margin-top:10px}
    .player{width:100%;aspect-ratio:16/9;position:relative;z-index:1}
    .player iframe{display:block;width:100%;height:100%;border:0;border-radius:12px}

    /* 커스텀 오버레이(항상 iframe 위에 위치) */
    .overlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.25));
      z-index:5; /* ← 중요: iframe보다 위 */
      transition:opacity .35s ease;
    }
    .overlay.fade{opacity:0;pointer-events:none}

    /* 재생 버튼 이미지(반응형, 절대 안 잘리게) */
    .play-img{
      display:block;
      width:clamp(84px, 26vw, 180px); /* 기본 크기 */
      height:auto; max-width:90vw; max-height:60vh; object-fit:contain; border-radius:50%;
      filter:drop-shadow(0 6px 24px rgba(0,0,0,.28));
      transition:transform .15s ease;
    }
    .overlay:active .play-img{transform:scale(.96)}

    .progress{height:8px;background:#f1f5f9;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;margin-top:12px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--cta-bg),#ffd29a)}
    .spacer{height:80px}

    @media (max-width:480px){
      .header{height:66px}
      .play-img{width:clamp(72px, 22vw, 140px)}
    }
    @media (max-width:360px){
      .header{height:62px}
      .play-img{width:clamp(64px, 24vw, 120px)}
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="wrap header">
        <div class="logo">
          <span class="logo-badge"><img src="./logo2.png" alt="logo" /></span>
          <span id="brandName">모든G, 다되G!</span>
        </div>
        <button id="couponBtn" class="btn btn-primary" disabled>모든G 쿠폰받기</button>
      </div>
    </header>

    <main class="wrap">
      <section class="card">
        <h1 id="headline">모든G 영상 시청하고 쿠폰도 받아보세요!</h1>
        <p class="muted">
          <span id="subcopy">영상 전체를 시청하면 상단의 [쿠폰받기]가 활성화됩니다.</span>
          <span class="muted" id="needSecWrap">(필요 시청: <strong id="needSec">-</strong>초)</span>
        </p>

        <div class="player-wrap">
          <div id="player" class="player"></div>
          <!-- 커스텀 재생 이미지 버튼 -->
          <div id="overlay" class="overlay" role="button" aria-label="재생">
            <img src="./play.png" alt="재생" class="play-img" />
          </div>
        </div>

        <div class="progress" aria-label="시청 진행률"><div id="bar" class="bar"></div></div>
      </section>
      <div class="spacer"></div>
    </main>
  </div>

  <script>
    // ===== 설정(요청 반영된 기본값) =====
    const CONFIG = {
      BRAND_NAME: '모든G, 다되G!',
      CTA_TEXT: '모든G 쿠폰받기',
      HEADLINE_TEXT: '모든G 영상 시청하고 쿠폰도 받아보세요!',
      SUB_TEXT: '영상 전체를 시청하면 상단의 [쿠폰받기]가 활성화됩니다.',
      COUPON_TARGET_URL: 'https://example.com/promo',
      DEFAULT_VIDEO: 'LtL4BLlLNko'
    };

    const Q = new URLSearchParams(location.search);
    const parseVideoId = (val)=>{
      if(!val) return '';
      try{
        if(/^[a-zA-Z0-9_-]{11}$/.test(val)) return val;
        const u=new URL(val);
        if(u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
        if(u.hostname.includes('youtube.com')) return (u.searchParams.get('v')||'').slice(0,11);
      }catch{}
      return val;
    };
    const VIDEO_ID = parseVideoId(Q.get('video')||Q.get('vid')||Q.get('v')||CONFIG.DEFAULT_VIDEO);
    const COUPON_URL = Q.get('url') || CONFIG.COUPON_TARGET_URL;

    document.getElementById('brandName').textContent = Q.get('brand') || CONFIG.BRAND_NAME;
    document.getElementById('couponBtn').textContent = Q.get('cta') || CONFIG.CTA_TEXT;
    document.getElementById('headline').textContent = Q.get('h1') || CONFIG.HEADLINE_TEXT;
    document.getElementById('subcopy').textContent = Q.get('sub') || CONFIG.SUB_TEXT;

    // ===== YouTube IFrame API 로드 =====
    let player, apiReady=false, watchTimer=null;
    let accumulated=0, lastTime=0, lastTickAt=0, rewarded=false, duration=0;
    (function loadYT(){ const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); })();

    window.onYouTubeIframeAPIReady=()=>{
      apiReady=true;
      player=new YT.Player('player',{
        videoId:VIDEO_ID,
        width:'100%',height:'100%',
        playerVars:{controls:1,rel:0,fs:0,modestbranding:1,disablekb:1,playsinline:1}, // 수동 재생
        events:{onReady, onStateChange}
      });
    };

    function onReady(){
      setTimeout(()=>{ duration=Math.floor(player.getDuration()||0); if(duration>0){ document.getElementById('needSec').textContent=duration; }}, 300);
      // 처음엔 오버레이가 클릭을 독점 (iframe 아래 z-index)
      // 클릭 시 재생 로직은 아래 overlay 핸들러
    }

    // 오버레이 클릭 → 재생 + 페이드아웃
    const overlay = document.getElementById('overlay');
    overlay.addEventListener('click', ()=>{
      if(!apiReady) return;
      try{ player.unMute?.(); player.playVideo?.(); }catch{}
      overlay.classList.add('fade');
      overlay.addEventListener('transitionend', ()=>{ overlay.style.display='none'; }, {once:true});
    });

    function onStateChange(e){
      const S=YT.PlayerState;
      if(e.data===S.PLAYING){
        if(!watchTimer){ lastTime=player.getCurrentTime(); lastTickAt=performance.now(); watchTimer=setInterval(sample,250); }
      }else if(e.data===S.PAUSED||e.data===S.BUFFERING){
        clearInterval(watchTimer); watchTimer=null;
      }else if(e.data===S.ENDED){
        clearInterval(watchTimer); watchTimer=null; activateCoupon();
      }
    }

    function sample(){
      const now=performance.now();
      const ct=player.getCurrentTime();
      const dt=(now-lastTickAt)/1000; let dHead=ct-lastTime;
      if(dHead>dt+0.75){ player.seekTo(lastTime,true); return; }
      if(dHead>0 && dHead<=dt+0.5){ accumulated+=Math.min(dHead,0.5); }

      const denom = duration>0 ? duration : Math.max(ct,1);
      const done = Math.min(accumulated, denom);
      document.getElementById('bar').style.width = `${(done/denom)*100}%`;

      if(duration>0 && !rewarded && accumulated >= duration - 0.5){ activateCoupon(); }
      lastTime=ct; lastTickAt=now;
    }

    function activateCoupon(){
      if(rewarded) return; rewarded=true;
      const btn = document.getElementById('couponBtn');
      btn.disabled=false; btn.classList.add('active'); btn.focus();
    }

    document.getElementById('couponBtn').addEventListener('click',()=>{
      const btn = document.getElementById('couponBtn');
      if(btn.disabled) return;
      location.href = COUPON_URL;
    });
  </script>
</body>
</html>
