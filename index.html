<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>쿠폰 받기 데모</title>
  <style>
    :root{
      /* 기본(라이트 테마로 변경) — 아래 JS에서 CONFIG.THEME 값으로 재정의됩니다 */
      --brand:#ff6b00; --bg:#f9f9f9; --text:#111827; --muted:#6b7280; --card:#ffffff; --stroke:#e5e7eb;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}

    .shell{min-height:100dvh;display:flex;flex-direction:column}
    .wrap{width:100%;max-width:720px;margin:0 auto;padding:0 16px}

    /* 헤더 */
    header{position:sticky;top:0;z-index:10;background:rgba(249,249,249,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--stroke)}
    .header{height:72px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 2px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .logo-badge{width:32px;height:32px;border-radius:8px;background:var(--brand);display:inline-flex;align-items:center;justify-content:center;color:#000;font-weight:900;overflow:hidden}
    .logo-badge img{width:100%;height:100%;object-fit:cover;display:block}

    .btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer;font-size:16px;transition:transform .15s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease}
    .btn-primary{background:var(--cta-bg, var(--brand));color:var(--cta-text, #fff);box-shadow:0 4px 14px color-mix(in srgb, var(--cta-bg, var(--brand)) 45%, transparent)}
    .btn-primary:active{transform:scale(.98)}
    /* 활성화 강조(shine + pulse + ring) */
    .btn-primary.active{position:relative;box-shadow:0 0 0 4px color-mix(in srgb, var(--cta-bg) 25%, #fff 0%),0 12px 28px color-mix(in srgb, var(--cta-bg) 55%, transparent);animation:pulse 1.4s ease-in-out infinite}
    .btn-primary.active::before{content:'';position:absolute;inset:-1px;pointer-events:none;border-radius:inherit;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.25) 40%,transparent 60%);filter:blur(0.5px);transform:translateX(-120%);animation:shine 1.6s linear infinite}
    @keyframes shine{to{transform:translateX(120%)}}
    @keyframes pulse{0%{transform:translateZ(0) scale(1)}50%{transform:translateZ(0) scale(1.04)}100%{transform:translateZ(0) scale(1)}}
    .btn-primary:active{transform:scale(.98)}
    .btn[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(.2)}
    .btn-primary.active{box-shadow:0 0 0 3px rgba(17,24,39,.08),0 10px 28px rgba(255,107,0,.45);animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%{transform:translateZ(0) scale(1)}50%{transform:translateZ(0) scale(1.04)}100%{transform:translateZ(0) scale(1)}}

    main{flex:1}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);margin:16px 0;padding:18px}
    h1{font-size:20px;margin:0 0 8px}
    .muted{color:var(--muted);font-size:14px}

    /* 플레이어 16:9 */
    .player-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;margin-top:10px}
    .player{width:100%;aspect-ratio:16/9}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(0,0,0,.5), rgba(0,0,0,.3));}

    /* 진행 바 */
    .progress{height:8px;background:#f1f5f9;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;margin-top:12px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),#ffd29a)}

    .spacer{height:80px}

    /* 버튼 색상 변
  .btn-primary.boost{animation:pop .5s ease}
    @keyframes pop{0%{transform:scale(.96)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="wrap header">
        <div class="logo">
          <span class="logo-badge" id="logoBadge">★</span>
          <span id="brandName">MY BRAND</span>
        </div>
        <button id="couponBtn" class="btn btn-primary" disabled title="영상 시청 후 활성화">쿠폰받기</button>
      </div>
    </header>

    <main class="wrap">
      <section class="card">
        <h1 id="headline">영상 시청 후 쿠폰을 받아보세요.</h1>
        <p class="muted"><span id="subcopy">영상 전체를 시청하면 상단의 [쿠폰받기]가 활성화됩니다.</span> <span class="muted" id="needSecWrap">(필요 시청: <strong id="needSec">-</strong>초)</span></p>

        <div class="player-wrap">
          <div id="player" class="player"></div>
          <div id="overlay" class="overlay">
            <button id="startBtn" class="btn btn-primary" style="width:90%">▶︎ 시청 시작</button>
          </div>
        </div>

        <div class="progress" aria-label="시청 진행률"><div id="bar" class="bar"></div></div>
      </section>
      <div class="spacer"></div>
    </main>
  </div>

  <script>
    /******** 쉽게 바꾸는 설정 ********/
    const CONFIG = {
      BRAND_NAME: '모든G, 다되G',                  // 상단 텍스트
      LOGO_IMG: './logo2.png',                            // 로고 이미지 PNG 경로(예: './logo.png')
      CTA_TEXT: '모든G 쿠폰받기',                     // 헤더 버튼 문구
      HEADLINE_TEXT: '모든G 영상도 보고 쿠폰도 받아보세요!',
      SUB_TEXT: '영상 전체를 시청하면 상단의 [모든G 쿠폰받기]가 활성화됩니다!',
      THEME: {                                 // 사이트 전반 색상
        bg: '#f9f9f9', text: '#111827', muted: '#6B7280', card: '#ffffff', stroke: '#e5e7eb', brand: '#ff6b00'
      },
      // ▶ 버튼 전용 색상 (원하면 THEME.brand와 다르게 설정)
      CTA_COLOR: { bg: '#ff6b00', text: '#ffffff' },

      COUPON_TARGET_URL: 'https://example.com/promo', // 쿠폰 페이지 URL (아래 QP url= 로도 교체 가능)
      DEFAULT_VIDEO: 'LtL4BLlLNko'             // 기본 유튜브 영상(ID만)
    };

    // URL로도 손쉽게 바꿀 수 있게: ?video=<ID or URL> & brand=... & cta=...
    const Q = new URLSearchParams(location.search);
    const parseVideoId = (val)=>{
      if(!val) return '';
      try{
        // ID가 바로 들어온 경우
        if(/^[a-zA-Z0-9_-]{11}$/.test(val)) return val;
        const u=new URL(val);
        if(u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
        if(u.hostname.includes('youtube.com')) return (u.searchParams.get('v')||'').slice(0,11);
      }catch{}
      return val;
    };
    const VIDEO_ID = parseVideoId(Q.get('video')||Q.get('vid')||Q.get('v')||CONFIG.DEFAULT_VIDEO);

    // 브랜드/문구 쿼리로도 교체 가능
    const BRAND_NAME = Q.get('brand') || CONFIG.BRAND_NAME;
    const CTA_TEXT   = Q.get('cta')   || CONFIG.CTA_TEXT;
    const HEADLINE   = Q.get('h1')    || CONFIG.HEADLINE_TEXT;
    const SUB_TEXT   = Q.get('sub')   || CONFIG.SUB_TEXT;
    const COUPON_URL = Q.get('url')   || CONFIG.COUPON_TARGET_URL;

    // 테마 적용
    (function applyTheme(t){
      const r=document.documentElement;
      r.style.setProperty('--bg', t.bg);
      r.style.setProperty('--text', t.text);
      r.style.setProperty('--muted', t.muted);
      r.style.setProperty('--card', t.card);
      r.style.setProperty('--stroke', t.stroke);
      r.style.setProperty('--brand', t.brand);
      // 헤더 배경도 라이트 기준으로 업데이트
      const header=document.querySelector('header');
      header.style.background = 'rgba(249,249,249,.85)';
    }) (CONFIG.THEME);

    // CTA 색상 적용 (CONFIG + URL 파라미터로도 교체 가능)
    (function applyCTA(){
      const CTA_BG = Q.get('ctabg') || (CONFIG.CTA_COLOR && CONFIG.CTA_COLOR.bg) || getComputedStyle(document.documentElement).getPropertyValue('--brand') || '#00ffb6';
      const CTA_TX = Q.get('ctatext') || (CONFIG.CTA_COLOR && CONFIG.CTA_COLOR.text) || '#ffffff';
      const r=document.documentElement;
      r.style.setProperty('--cta-bg', CTA_BG.trim());
      r.style.setProperty('--cta-text', CTA_TX.trim());
    })();

    // 브랜드/문구 바인딩
    document.getElementById('brandName').textContent = BRAND_NAME;
    document.getElementById('couponBtn').textContent = CTA_TEXT;
    document.getElementById('headline').textContent = HEADLINE;
    document.getElementById('subcopy').textContent = SUB_TEXT;

    // 로고 이미지가 있으면 교체
    if(CONFIG.LOGO_IMG){
      const badge=document.getElementById('logoBadge');
      badge.innerHTML = `<img src="${CONFIG.LOGO_IMG}" alt="logo" />`;
    }

    /******** 시청 로직: "영상 전체"를 봐야 활성화 ********/
    const $ = s=>document.querySelector(s);
    const overlay = $('#overlay');
    const startBtn = $('#startBtn');
    const bar = $('#bar');
    const couponBtn = $('#couponBtn');
    const needSecEl = $('#needSec');

    let player, apiReady=false, watchTimer=null;
    let accumulated=0, lastTime=0, lastTickAt=0, rewarded=false;
    let duration=0; // 전체 길이(초)

    (function loadYT(){ const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.head.appendChild(tag); })();
    window.onYouTubeIframeAPIReady=()=>{
      apiReady=true;
      player=new YT.Player('player',{
        videoId:VIDEO_ID,
        width:'100%',height:'100%',
        playerVars:{controls:0,rel:0,fs:0,modestbranding:1,disablekb:1,playsinline:1},
        events:{onReady, onStateChange}
      });
    };

    function onReady(){
      // 메타데이터에서 전체 길이 확인
      setTimeout(()=>{
        duration = Math.floor(player.getDuration()||0);
        if(duration>0){ needSecEl.textContent = duration; }
      }, 250);
      startBtn.disabled=false;
    }

    // 탭 이탈/포커스 아웃 시 정지
    document.addEventListener('visibilitychange',()=>{ if(document.hidden && player?.pauseVideo){ player.pauseVideo(); }});
    window.addEventListener('blur',()=>{ if(player?.pauseVideo){ player.pauseVideo(); }});

    startBtn.addEventListener('click',()=>{ if(!apiReady) return; overlay.style.display='none'; try{ player.playVideo(); }catch(e){} });

    function onStateChange(e){
      const S=YT.PlayerState;
      if(e.data===S.PLAYING){ if(!watchTimer){ lastTime=player.getCurrentTime(); lastTickAt=performance.now(); watchTimer=setInterval(sample,250);} }
      else if(e.data===S.PAUSED||e.data===S.BUFFERING){ clearInterval(watchTimer); watchTimer=null; }
      else if(e.data===S.ENDED){ clearInterval(watchTimer); watchTimer=null; // 전체 시청 완료로 간주
        activateCoupon(); }
    }

    function sample(){
      const now=performance.now();
      const ct=player.getCurrentTime();
      const dt=(now-lastTickAt)/1000; let dHead=ct-lastTime;
      if(dHead>dt+0.75){ player.seekTo(lastTime,true); return; }
      if(dHead>0 && dHead<=dt+0.5){ accumulated+=Math.min(dHead,0.5); }

      // 진행바 (전체 길이 기준). duration이 아직 0이면 헤드 위치로 대체
      const denom = duration>0 ? duration : Math.max(ct,1);
      const done = Math.min(accumulated, denom);
      bar.style.width = `${(done/denom)*100}%`;

      // 전체 길이에 근접(오차 0.5s)하면 발급
      if(duration>0 && !rewarded && accumulated >= duration - 0.5){
        activateCoupon();
      }

      lastTime=ct; lastTickAt=now;
    }

    function activateCoupon(){
      if(rewarded) return; rewarded=true;
      couponBtn.disabled=false;
      couponBtn.classList.add('active','boost');
      setTimeout(()=>couponBtn.classList.remove('boost'), 1200);
      couponBtn.setAttribute('aria-live','polite');
      couponBtn.setAttribute('aria-label','쿠폰받기 버튼이 활성화되었습니다');
      couponBtn.focus();
    }

    // [쿠폰받기] 클릭 → 바로 이동(같은 탭). 새 탭이면 window.open 사용
    couponBtn.addEventListener('click',()=>{
      if(couponBtn.disabled) return;
      location.href = COUPON_URL; // 새 탭: window.open(COUPON_URL, '_blank', 'noopener');
    });
  </script>
</body>
</html>
