<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹œì²­ ì™„ë£Œ í›„ ì¿ í° ë°œê¸‰</title>
  <style>
    :root{
      --brand:#ff6b00;
      --bg:#0f1115;
      --text:#e8ecf1;
      --muted:#a5adba;
      --card:#171a21;
      --ok:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .container{max-width:920px;margin:32px auto;padding:16px}
    .card{background:var(--card);border:1px solid #212532;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 8px}
    .muted{color:var(--muted)}
    .player-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
    .player{width:100%;aspect-ratio:16/9}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.35));}
    .btn{appearance:none;border:0;border-radius:999px;padding:14px 22px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff;box-shadow:0 8px 20px rgba(255,107,0,.35)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .grow{flex:1 1 340px}
    .progress{height:10px;background:#232836;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),#ffd29a)}
    .kpis{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid #263044;border-radius:999px;background:#131722}
    .pill.ok{border-color:#1f5130;background:#0e1b13;color:#9ef7b1}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal{background:var(--card);border:1px solid #2a3142;border-radius:16px;max-width:520px;width:100%;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.4)}
    .coupon{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0f151d;border:1px dashed #334155;color:#e2e8f0;padding:12px 14px;border-radius:12px;font-size:20px;letter-spacing:2px;text-align:center}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .notice{font-size:12px;color:var(--muted);margin-top:10px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ì˜ìƒ ì‹œì²­ í›„ ì¿ í° ë°›ê¸°</h1>
      <p class="muted">ì•„ë˜ ìœ íŠœë¸Œ ì˜ìƒì„ <strong id="needSec">50</strong>ì´ˆ ì´ìƒ ì‹œì²­í•˜ë©´ ì¿ í°ì´ ë°œê¸‰ë©ë‹ˆë‹¤. (íƒ­ì„ ë²—ì–´ë‚˜ë©´ ì¼ì‹œì •ì§€ë¼ìš”)</p>

      <div class="row">
        <div class="grow">
          <div class="player-wrap">
            <div id="player" class="player"></div>
            <div id="overlay" class="overlay">
              <button id="startBtn" class="btn btn-primary">â–¶ï¸ ì‹œì²­ ì‹œì‘</button>
            </div>
          </div>
        </div>
        <div style="flex:1 1 260px;min-width:240px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:.5rem 0 .75rem">
            <div class="muted">ì‹œì²­ ì§„í–‰ë¥ </div>
            <div id="progressText" class="muted">0 / 50ì´ˆ</div>
          </div>
          <div class="progress" aria-label="ì‹œì²­ ì§„í–‰ë¥ ">
            <div id="bar" class="bar"></div>
          </div>
          <div class="kpis">
            <div id="guardFocus" class="pill">í¬ì»¤ìŠ¤ ê°ì‹œ: <strong>ON</strong></div>
            <div id="guardSeek" class="pill">ê±´ë„ˆë›°ê¸° ë°©ì§€: <strong>ON</strong></div>
            <div id="status" class="pill">ìƒíƒœ: <strong>ëŒ€ê¸°</strong></div>
          </div>
          <div class="notice">â€» ì‹¤ì œë¡œ "ì‹œì²­í–ˆëŠ”ì§€"ëŠ” ë¸Œë¼ìš°ì € í´ë¼ì´ì–¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ê²€ì¦ë©ë‹ˆë‹¤. ë³´ì•ˆì´ ì¤‘ìš”í•œ ë°°í¬ í™˜ê²½ì—ì„œëŠ” ì„œë²„ ê²€ì¦ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì™„ë£Œ ëª¨ë‹¬ -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 style="margin-top:0">ì¶•í•˜í•©ë‹ˆë‹¤! ì¿ í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰</h2>
      <p class="muted" style="margin-top:4px">ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ ê²°ì œ ë‹¨ê³„ì—ì„œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
      <div id="coupon" class="coupon" aria-live="polite">XXXX-XXXX-XXXX</div>
      <div class="actions">
        <button id="copyBtn" class="btn">ë³µì‚¬</button>
        <button id="closeBtn" class="btn btn-primary">ë‹«ê¸°</button>
      </div>
      <div class="notice">ì´ ì½”ë“œëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. ì‹¤ì œ ë°°í¬ ì‹œ ì„œë²„ì—ì„œ ì¼íšŒìš© ì¿ í°ì„ ë°œê¸‰/ê²€ì¦í•˜ì„¸ìš”.</div>
    </div>
  </div>

  <script>
    /*********************************
     * ì„¤ì • (í•„ìˆ˜ ê°’ë§Œ ë°”ê¿” ì“°ì„¸ìš”)
     *********************************/
    const VIDEO_ID = "M7lc1UVf-VE"; // ì„ì‹œ ë°ëª¨ ì˜ìƒ ID (YouTube API ê³µì‹ ë°ëª¨)
    const WATCH_THRESHOLD_SECONDS = 50; // ì¿ í° ë°œê¸‰ê¹Œì§€ í•„ìš”í•œ ì‹œì²­ ì‹œê°„(ì´ˆ)

    // UIì— ë°˜ì˜
    document.getElementById('needSec').textContent = WATCH_THRESHOLD_SECONDS;

    /*********************************
     * ìœ í‹¸
     *********************************/
    const $ = (sel) => document.querySelector(sel);
    const overlay = $('#overlay');
    const startBtn = $('#startBtn');
    const bar = $('#bar');
    const progressText = $('#progressText');
    const statusText = $('#status');
    const modal = $('#modal');
    const couponEl = $('#coupon');

    function setStatus(text){ statusText.innerHTML = `ìƒíƒœ: <strong>${text}</strong>`; }
    function fmt(s){ return Math.floor(s).toString(); }
    function randCoupon(){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const block = () => Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
      return `${block()}-${block()}-${block()}`;
    }

    // ëª¨ë‹¬ ì»¨íŠ¸ë¡¤
    function openModal(){ modal.style.display='flex'; }
    function closeModal(){ modal.style.display='none'; }
    $('#closeBtn').addEventListener('click', closeModal);
    $('#copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(couponEl.textContent.trim()); alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
      catch(e){ alert('ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.'); }
    });

    /*********************************
     * YouTube IFrame Player API ë¡œë“œ
     *********************************/
    let player, apiReady=false, watchTimer=null;
    let accumulated = 0;        // ëˆ„ì  ì‹œì²­ ì‹œê°„(ì´ˆ)
    let lastTime = 0;           // ì§ì „ ìƒ˜í”Œì˜ í”Œë ˆì´í—¤ë“œ ìœ„ì¹˜
    let lastTickAt = 0;         // ì§ì „ ìƒ˜í”Œì˜ íƒ€ì„ìŠ¤íƒ¬í”„(ms)
    let rewarded = false;       // ì¿ í° ë°œê¸‰ ì—¬ë¶€

    // API ìŠ¤í¬ë¦½íŠ¸ ì£¼ì…
    (function loadYT(){
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
    })();

    // ì „ì—­ ì½œë°± (YouTubeê°€ í˜¸ì¶œ)
    window.onYouTubeIframeAPIReady = () => {
      apiReady = true;
      player = new YT.Player('player', {
        videoId: VIDEO_ID,
        width: '100%',
        height: '100%',
        playerVars: {
          controls: 0,        // ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ (ê±´ë„ˆë›°ê¸° ë°©ì§€)
          rel: 0,
          fs: 0,
          modestbranding: 1,
          disablekb: 1,       // í‚¤ë³´ë“œ íƒìƒ‰ ë°©ì§€
          playsinline: 1,
          // mute: 1,        // í•„ìš” ì‹œ ìë™ì¬ìƒ ëŒ€ë¹„ ë¬´ìŒ ì„¤ì •
        },
        events: {
          onReady: onReady,
          onStateChange: onStateChange,
        }
      });
    };

    function onReady(){
      setStatus('ëŒ€ê¸°');
      startBtn.disabled = false;
    }

    // ê°€ì‹œì„±/í¬ì»¤ìŠ¤ ê°ì‹œ: íƒ­ì„ ë²—ì–´ë‚˜ë©´ ì¼ì‹œì •ì§€
    document.addEventListener('visibilitychange', () => {
      if(document.hidden && player && player.pauseVideo){ player.pauseVideo(); setStatus('ì¼ì‹œì •ì§€(íƒ­ ì´íƒˆ)'); }
    });
    window.addEventListener('blur', () => { if(player && player.pauseVideo){ player.pauseVideo(); setStatus('ì¼ì‹œì •ì§€(í¬ì»¤ìŠ¤ ì•„ì›ƒ)'); } });

    // ì‹œì‘ ë²„íŠ¼
    startBtn.addEventListener('click', async () => {
      if(!apiReady) return;
      overlay.style.display='none';
      try { player.playVideo(); setStatus('ì¬ìƒ ì¤‘'); } catch(e){ setStatus('ì¬ìƒ ì‹¤íŒ¨'); }
    });

    function onStateChange(e){
      const YTS = YT.PlayerState;
      if(e.data === YTS.PLAYING){
        // í´ë§ ì‹œì‘
        if(!watchTimer){
          lastTime = player.getCurrentTime();
          lastTickAt = performance.now();
          watchTimer = setInterval(sampleWatch, 250);
        }
      } else if(e.data === YTS.PAUSED || e.data === YTS.BUFFERING){
        if(watchTimer){ clearInterval(watchTimer); watchTimer = null; }
        if(e.data === YTS.PAUSED) setStatus('ì¼ì‹œì •ì§€');
      } else if(e.data === YTS.ENDED){
        if(watchTimer){ clearInterval(watchTimer); watchTimer = null; }
        setStatus('ì˜ìƒ ì¢…ë£Œ');
      }
    }

    // ì‹œì²­ ì‹œê°„ ìƒ˜í”Œë§/ê²€ì¦ ë£¨í”„
    function sampleWatch(){
      if(!player) return;
      const now = performance.now();
      const ct = player.getCurrentTime();
      const dtWall = (now - lastTickAt) / 1000;       // ì‹¤ì œ ê²½ê³¼ ì‹œê°„(ì´ˆ)
      let dHead = ct - lastTime;                      // í—¤ë“œ ì´ë™(ì´ˆ)

      // ì‚¬ìš©ìê°€ ì•ìœ¼ë¡œ í¬ê²Œ ì í”„í•˜ë©´ ë˜ëŒë¦¬ê¸° (ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ ìƒíƒœë¼ ê±°ì˜ ì—†ìŒ)
      if(dHead > dtWall + 0.75){
        // ê³¼ë„í•œ ì í”„ íƒì§€ â†’ í—ˆìš©ì¹˜ ì´ˆê³¼ ì‹œ ë§ˆì§€ë§‰ ì‹œì ìœ¼ë¡œ ë³µê·€
        player.seekTo(lastTime, true);
        return;
      }

      // ì •ìƒ ì¬ìƒìœ¼ë¡œ íŒë‹¨ë˜ëŠ” êµ¬ê°„ë§Œ ëˆ„ì 
      if(dHead > 0 && dHead <= dtWall + 0.5){
        accumulated += Math.min(dHead, 0.5); // ìƒ˜í”Œë§ ê°„ ê³¼ë„ ëˆ„ì  ë°©ì§€
      }

      // UI ì—…ë°ì´íŠ¸
      const need = WATCH_THRESHOLD_SECONDS;
      const clamped = Math.min(accumulated, need);
      progressText.textContent = `${fmt(clamped)} / ${need}ì´ˆ`;
      bar.style.width = `${(clamped/need)*100}%`;

      // ë°œê¸‰ ì²˜ë¦¬ (1íšŒ)
      if(!rewarded && accumulated >= need){
        rewarded = true;
        setStatus('ë‹¬ì„± ì™„ë£Œ');
        couponEl.textContent = randCoupon();
        openModal();
      }

      lastTime = ct;
      lastTickAt = now;
    }
  </script>
</body>
</html>
